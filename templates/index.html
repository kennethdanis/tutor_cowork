<!DOCTYPE html>
<html>
<head>
    <title>Tutor Cowork</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        input[type="text"] {
            width: 100%;
            height: 3em; /* roughly two lines tall */
            font-size: 1em;
            white-space: normal; /* allow wrapping (visual, even if input is single-line) */
        }
    </style>
</head>
<body>
    <h2>English:</h2>
    <p id="english-sentence">{{ english }}</p>

    <h3>Italian Translation</h3>
    <input type="text" id="italian-box" oninput="checkInput('italian')">
    <button onclick="showTranslation('italian')">Show Translation</button>
    <button id="save-italian" onclick="saveTranslation('italian')" disabled>Save Changes</button>
    <button onclick="playAudio('italian')">Play Translation</button>

    <h3>Spanish Translation</h3>
    <input type="text" id="spanish-box" oninput="checkInput('spanish')">
    <button onclick="showTranslation('spanish')">Show Translation</button>
    <button id="save-spanish" onclick="saveTranslation('spanish')" disabled>Save Changes</button>
    <button onclick="playAudio('spanish')">Play Translation</button>

    <br><br>
    <button onclick="nextSentence()">Next Sentence</button>

    <audio id="audio-player" style="display:none;"></audio>

    <script>
        const socket = io();

        const originalText = {
            italian: '',
            spanish: ''
        };

        function showTranslation(lang) {
            socket.emit('show_translation', { language: lang });
        }

        function saveTranslation(lang) {
            const text = document.getElementById(lang + '-box').value;
            const confirmSave = confirm(`Are you sure you want to save this ${lang} translation?\n\n"${text}"`);
            if (confirmSave) {
                socket.emit('save_translation', { language: lang, text: text });
                document.getElementById(`save-${lang}`).disabled = true;
                originalText[lang] = text;
            }
        }

        function playAudio(lang) {
            socket.emit('play_audio', { language: lang });
        }

        function nextSentence() {
            socket.emit('next_sentence');
        }

        function checkInput(lang) {
            const current = document.getElementById(`${lang}-box`).value;
            const isChanged = current.trim() !== originalText[lang].trim();
            document.getElementById(`save-${lang}`).disabled = !isChanged;
        }

        socket.on('update_translation', data => {
            document.getElementById(`${data.language}-box`).value = data.text;
            originalText[data.language] = data.text;
            document.getElementById(`save-${data.language}`).disabled = true;
        });

        socket.on('play_audio_file', data => {
            const audio = document.getElementById('audio-player');
            audio.src = data.file_path;
            audio.play();
        });

        socket.on('new_sentence', data => {
            document.getElementById('english-sentence').innerText = data.english;
            ['italian', 'spanish'].forEach(lang => {
                document.getElementById(`${lang}-box`).value = '';
                originalText[lang] = '';
                document.getElementById(`save-${lang}`).disabled = true;
            });
        });

        socket.on('save_success', data => {
            alert(`${data.language} translation saved!`);
        });
    </script>
</body>
</html>
